rules:
  # Connascence of Meaning - Magic Numbers and String Literals
  - id: magic-numbers-com
    pattern-either:
      - pattern: |
          if ($X == $NUM) { ... }
      - pattern: |
          if ($X === $NUM) { ... }
      - pattern: |
          while ($X == $NUM) { ... }
      - pattern: |
          $X == $NUM
    metavariable-regex:
      metavariable: $NUM
      regex: '^[0-9]+(\.[0-9]+)?$'
    message: |
      Magic number detected. This creates Connascence of Meaning (CoM) where multiple
      locations must agree on what this number means. Consider extracting to a named constant.
    languages:
      - javascript
      - typescript
    severity: WARNING
    metadata:
      category: connascence-of-meaning
      cwe: "CWE-547: Use of Hard-coded Security-relevant Constants"
      owasp: "A04:2021 - Insecure Design"
      confidence: HIGH
      impact: MEDIUM
      likelihood: HIGH
      technology:
        - javascript
        - typescript
      subcategory:
        - audit
      references:
        - https://connascence.io/meaning.html
      fix_guidance: |
        Extract magic numbers to named constants:
        ```javascript
        // Before
        if (status == 200) { ... }
        
        // After  
        const HTTP_OK = 200;
        if (status === HTTP_OK) { ... }
        ```
    fix: |
      const $CONSTANT_NAME = $NUM;
      if ($X === $CONSTANT_NAME) { ... }

  - id: magic-strings-com
    pattern-either:
      - pattern: |
          if ($X == "$STR") { ... }
      - pattern: |
          if ($X === "$STR") { ... }
      - pattern: |
          case "$STR": ...
      - pattern: |
          $OBJ["$STR"]
    metavariable-regex:
      metavariable: $STR
      regex: '^[a-zA-Z][a-zA-Z0-9_-]+$'
    message: |
      Magic string literal creates Connascence of Meaning (CoM). Multiple locations
      must agree on the exact string value. Consider extracting to a named constant.
    languages:
      - javascript
      - typescript
    severity: WARNING
    metadata:
      category: connascence-of-meaning
      confidence: HIGH
      impact: MEDIUM
      likelihood: HIGH
      fix_guidance: |
        Extract magic strings to constants:
        ```javascript
        // Before
        if (type === "admin") { ... }
        
        // After
        const USER_TYPE_ADMIN = "admin";
        if (type === USER_TYPE_ADMIN) { ... }
        ```

  - id: duplicate-validation-logic-com
    pattern-either:
      - pattern: |
          if ($X.length < $N) {
            throw new Error("$MSG");
          }
      - pattern: |
          if (!$X.match($REGEX)) {
            throw new Error("$MSG");
          }
    message: |
      Duplicate validation logic creates Connascence of Meaning (CoM). 
      Multiple locations must agree on validation rules.
      Consider centralizing validation logic.
    languages:
      - javascript
      - typescript
    severity: WARNING
    metadata:
      category: connascence-of-meaning
      confidence: MEDIUM
      impact: HIGH
      likelihood: MEDIUM
      fix_guidance: |
        Centralize validation:
        ```javascript
        // Before (duplicated everywhere)
        if (email.length < 5) throw new Error("Invalid email");
        
        // After
        const validateEmail = (email) => {
          if (email.length < 5) throw new Error("Invalid email");
        };
        ```

  # Python magic numbers
  - id: python-magic-numbers-com
    pattern-either:
      - pattern: |
          if $X == $NUM:
              ...
      - pattern: |
          while $X == $NUM:
              ...
      - pattern: |
          $X == $NUM
    metavariable-regex:
      metavariable: $NUM
      regex: '^[0-9]+(\.[0-9]+)?$'
    message: |
      Magic number creates Connascence of Meaning (CoM). Extract to named constant.
    languages:
      - python
    severity: WARNING
    metadata:
      category: connascence-of-meaning
      confidence: HIGH
      impact: MEDIUM
      likelihood: HIGH
      fix_guidance: |
        Use constants:
        ```python
        # Before
        if response.status_code == 200:
            ...
            
        # After
        HTTP_OK = 200
        if response.status_code == HTTP_OK:
            ...
        ```

  # Java magic numbers
  - id: java-magic-numbers-com
    pattern-either:
      - pattern: |
          if ($X == $NUM) {
              ...
          }
      - pattern: |
          while ($X == $NUM) {
              ...
          }
    metavariable-regex:
      metavariable: $NUM
      regex: '^[0-9]+(\.[0-9]+)?$'
    message: |
      Magic number creates Connascence of Meaning (CoM). Use constants instead.
    languages:
      - java
    severity: WARNING
    metadata:
      category: connascence-of-meaning
      confidence: HIGH
      impact: MEDIUM
      likelihood: HIGH
      fix_guidance: |
        Extract to constants:
        ```java
        // Before
        if (statusCode == 404) { ... }
        
        // After
        private static final int HTTP_NOT_FOUND = 404;
        if (statusCode == HTTP_NOT_FOUND) { ... }
        ```