name: Quality Gates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Python Dependency Audit
        run: |
          pip install safety pip-audit
          pip install -e ".[dev,mcp,vscode,enterprise]"
          safety check --json > safety-report.json || true
          pip-audit --format json > pip-audit-report.json || true

      - name: Node.js Dependency Audit
        working-directory: interfaces/vscode
        run: |
          npm install
          npm audit --json > npm-audit-report.json || true

      - name: Upload Audit Reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-audit-reports
          path: |
            safety-report.json
            pip-audit-report.json
            interfaces/vscode/npm-audit-report.json

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install bandit[toml] semgrep ruff

      - name: Run Bandit Security Scan
        run: |
          bandit -r analyzer interfaces mcp -f json -o bandit-report.json
        continue-on-error: true

      - name: Run Semgrep Security Scan
        run: |
          semgrep --config=auto --json --output=semgrep-report.json analyzer/ interfaces/ mcp/
        continue-on-error: true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-reports
          path: |
            bandit-report.json
            semgrep-report.json

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Python Tools
        run: |
          pip install ruff black mypy radon
          pip install -e ".[dev,mcp,vscode,enterprise]"

      - name: Python Linting (Ruff)
        run: |
          ruff check analyzer/ interfaces/ mcp/ tests/ --output-format=json > ruff-report.json || true

      - name: Python Type Checking (MyPy)
        run: |
          mypy analyzer interfaces mcp --json-report mypy-report --html-report mypy-html || true

      - name: Python Code Complexity (Radon)
        run: |
          radon cc analyzer/ interfaces/ mcp/ -j > radon-cc-report.json || true
          radon mi analyzer/ interfaces/ mcp/ -j > radon-mi-report.json || true

      - name: Install TypeScript Dependencies
        working-directory: interfaces/vscode
        run: npm install

      - name: TypeScript Linting (ESLint)
        working-directory: interfaces/vscode
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true

      - name: TypeScript Type Checking
        working-directory: interfaces/vscode
        run: |
          npm run compile || true

      - name: Upload Quality Reports
        uses: actions/upload-artifact@v3
        with:
          name: code-quality-reports
          path: |
            ruff-report.json
            mypy-report/
            radon-cc-report.json
            radon-mi-report.json
            interfaces/vscode/eslint-report.json

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Python Dependencies
        run: |
          pip install pytest pytest-cov
          pip install -e ".[dev,mcp,vscode,enterprise]"

      - name: Run Python Tests with Coverage
        run: |
          pytest tests/ \
            --cov=analyzer \
            --cov=interfaces \
            --cov=mcp \
            --cov-report=html:coverage-html \
            --cov-report=json:coverage.json \
            --cov-report=xml:coverage.xml \
            --junitxml=pytest-results.xml \
            || true

      - name: Install TypeScript Dependencies
        working-directory: interfaces/vscode
        run: npm install

      - name: Run VSCode Extension Tests
        working-directory: interfaces/vscode
        run: |
          xvfb-run -a npm test || true

      - name: Coverage Quality Gate
        run: |
          python -c "
          import json
          with open('coverage.json') as f:
              data = json.load(f)
              coverage = data['totals']['percent_covered']
              print(f'Coverage: {coverage:.2f}%')
              if coverage < 60:
                  print('WARNING: Coverage below 60%')
              if coverage < 40:
                  exit(1)  # Fail if below 40%
          " || echo "Coverage check completed with warnings"

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage-html/
            coverage.json
            coverage.xml
            pytest-results.xml

  metrics-dashboard:
    name: Generate Metrics Dashboard
    runs-on: ubuntu-latest
    needs: [dependency-audit, security-scan, code-quality, test-coverage]
    if: always()
    steps:
      - uses: actions/checkout@v3

      - name: Download All Reports
        uses: actions/download-artifact@v3

      - name: Generate Dashboard
        run: |
          python scripts/generate_quality_dashboard.py || echo "Dashboard generation skipped (script not found)"

      - name: Upload Dashboard
        uses: actions/upload-artifact@v3
        with:
          name: quality-dashboard
          path: quality-dashboard.html
        if: success()

  quality-gate-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, security-scan, code-quality, test-coverage]
    if: always()
    steps:
      - name: Check Quality Gates
        run: |
          echo "## Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Post Status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Quality Gates Report\n\n' +
                    '- Dependency Audit: ${{ needs.dependency-audit.result }}\n' +
                    '- Security Scan: ${{ needs.security-scan.result }}\n' +
                    '- Code Quality: ${{ needs.code-quality.result }}\n' +
                    '- Test Coverage: ${{ needs.test-coverage.result }}\n\n' +
                    'View detailed reports in workflow artifacts.'
            })
