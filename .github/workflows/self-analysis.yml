name: Self-Analysis Quality Gate
# Dogfooding: Run Clarity Linter + Connascence Analysis on every PR

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.py'
      - '**.js'
      - '**.ts'
      - '**.java'
      - '**.go'
      - '**.rs'
      - '**.cpp'
      - '**.h'
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  quality-gate:
    name: Quality Gate Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trend analysis

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Clarity Linter
        id: clarity
        continue-on-error: true
        run: |
          python -m analyzer.clarity_linter \
            --config clarity_linter.yaml \
            --output-format sarif \
            --output-file clarity_results.sarif \
            --output-format json \
            --output-file clarity_results.json \
            --output-format markdown \
            --output-file clarity_results.md \
            --fail-on high \
            --verbose

      - name: Run Connascence Analysis
        id: connascence
        continue-on-error: true
        run: |
          python analyzer/check_connascence.py . \
            --format json \
            --output connascence_results.json || echo "{\"violations\": []}" > connascence_results.json

      - name: Run NASA Standard Checks
        id: nasa
        continue-on-error: true
        run: |
          cd analyzer && python core.py \
            --path .. \
            --policy nasa_jpl_pot10 \
            --format json \
            --output ../nasa_compliance.json || echo "{\"compliance_score\": 0}" > ../nasa_compliance.json

      - name: Merge SARIF Results
        run: |
          python -c "
          import json
          from pathlib import Path

          # Merge SARIF files
          clarity = json.loads(Path('clarity_results.sarif').read_text()) if Path('clarity_results.sarif').exists() else None
          connascence = json.loads(Path('connascence_results.sarif').read_text()) if Path('connascence_results.sarif').exists() else None

          if clarity and connascence:
              merged = {
                  'version': '2.1.0',
                  '\$schema': 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json',
                  'runs': clarity.get('runs', []) + connascence.get('runs', [])
              }
              Path('merged_results.sarif').write_text(json.dumps(merged, indent=2))
          elif clarity:
              Path('merged_results.sarif').write_text(json.dumps(clarity, indent=2))
          elif connascence:
              Path('merged_results.sarif').write_text(json.dumps(connascence, indent=2))
          "

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: merged_results.sarif
          category: quality-gate

      - name: Generate Quality Report
        if: always()
        run: |
          python -c "
          import json
          from pathlib import Path
          from datetime import datetime

          # Load results
          clarity = json.loads(Path('clarity_results.json').read_text()) if Path('clarity_results.json').exists() else {}
          connascence = json.loads(Path('connascence_results.json').read_text()) if Path('connascence_results.json').exists() else {}
          nasa = json.loads(Path('nasa_compliance.json').read_text()) if Path('nasa_compliance.json').exists() else {}

          # Generate markdown report
          report = [
              '# Quality Gate Report',
              f'**Generated:** {datetime.utcnow().isoformat()}Z',
              '',
              '## Summary',
              '',
          ]

          # Clarity Linter section
          if clarity:
              violations = clarity.get('violations', [])
              critical = len([v for v in violations if v.get('severity') == 'critical'])
              high = len([v for v in violations if v.get('severity') == 'high'])
              medium = len([v for v in violations if v.get('severity') == 'medium'])
              low = len([v for v in violations if v.get('severity') == 'low'])

              report.extend([
                  '### Clarity Linter',
                  f'- **Total Violations:** {len(violations)}',
                  f'- **Critical:** {critical}',
                  f'- **High:** {high}',
                  f'- **Medium:** {medium}',
                  f'- **Low:** {low}',
                  '',
              ])

          # Connascence Analysis section
          if connascence:
              violations = connascence.get('violations', [])
              report.extend([
                  '### Connascence Analysis',
                  f'- **Total Violations:** {len(violations)}',
                  f'- **Types Detected:** {len(set(v.get(\"type\") for v in violations))}',
                  '',
              ])

          # NASA Compliance section
          if nasa:
              score = nasa.get('compliance_score', 0)
              report.extend([
                  '### NASA STD-8739.8 Compliance',
                  f'- **Compliance Score:** {score}%',
                  f'- **Status:** {\"PASS\" if score >= 90 else \"FAIL\"}',
                  '',
              ])

          # Top violations
          if clarity and violations:
              report.extend([
                  '## Top 10 Clarity Violations',
                  '',
              ])
              for i, v in enumerate(violations[:10], 1):
                  report.extend([
                      f'### {i}. {v.get(\"rule_id\")}: {v.get(\"message\")}',
                      f'- **File:** {v.get(\"file\")}:{v.get(\"line\")}',
                      f'- **Severity:** {v.get(\"severity\")}',
                      f'- **Fix:** {v.get(\"fix_suggestion\", \"N/A\")}',
                      '',
                  ])

          Path('quality_report.md').write_text('\n'.join(report))
          "

      - name: Post PR Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Upload Quality Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-gate-results
          path: |
            clarity_results.*
            connascence_results.*
            nasa_compliance.json
            quality_report.md
            merged_results.sarif
          retention-days: 30

      - name: Check Quality Gate Status
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path

          # Load results
          clarity = json.loads(Path('clarity_results.json').read_text()) if Path('clarity_results.json').exists() else {}

          violations = clarity.get('violations', [])
          critical = len([v for v in violations if v.get('severity') == 'critical'])
          high = len([v for v in violations if v.get('severity') == 'high'])

          print(f'Quality Gate: {critical} critical, {high} high violations')

          # Fail if critical or high violations
          if critical > 0 or high > 0:
              print('❌ QUALITY GATE FAILED: Critical or high severity violations detected')
              sys.exit(1)
          else:
              print('✅ QUALITY GATE PASSED')
              sys.exit(0)
          "

      - name: Create Check Run
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const clarityResults = JSON.parse(fs.readFileSync('clarity_results.json', 'utf8'));

            const violations = clarityResults.violations || [];
            const critical = violations.filter(v => v.severity === 'critical').length;
            const high = violations.filter(v => v.severity === 'high').length;

            const conclusion = (critical > 0 || high > 0) ? 'failure' : 'success';
            const summary = `Quality Gate: ${critical} critical, ${high} high violations`;

            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Quality Gate',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Quality Gate Analysis',
                summary: summary,
                text: fs.readFileSync('quality_report.md', 'utf8')
              }
            });
